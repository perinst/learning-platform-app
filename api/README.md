# Learning Platform API

A RESTful API for a learning platform with Express authentication proxy, PostgREST, and PostgreSQL.

## üìö Documentation

Complete documentation is in the [`docs`](./docs) folder:

- **[Quick Start](./docs/QUICKSTART.md)** - Get started in minutes
- **[Dev/Prod Guide](./docs/DEV-PROD-GUIDE.md)** - Development and production workflows
- **[Architecture Comparison](./docs/ARCHITECTURE-COMPARISON.md)** - Visual comparison
- **[Auth Proxy Guide](./docs/AUTH-PROXY-GUIDE.md)** - Authentication documentation
- **[RBAC Guide](./docs/RBAC-GUIDE.md)** - Role-based access control
- **[PostgREST API Guide](./docs/POSTGREST-GUIDE.md)** - API endpoints reference
- **[Security Guide](./docs/BLOCKING-POSTGREST.md)** - PostgREST isolation

[üìö View All Documentation](./docs/README.md)

## Tech Stack

- **TypeScript & Express** - Authentication proxy with RBAC
- **PostgreSQL** - Database with pgcrypto for password hashing
- **PostgREST** - Auto-generated REST API from database schema
- **Docker & Docker Compose** - Containerized deployment
- **Adminer** - Database management UI

## Getting Started

### Prerequisites

- Docker Desktop installed
- Node.js 18+ (for local development)

### Setup

1. Clone the repository

```bash
cd learning-platform-api
```

2. Start the database with Docker Compose

```bash
docker-compose up -d
```

This will:

- Start PostgreSQL on port 5432
- Start Adminer (database UI) on port 8080
- Automatically create the database schema and seed data

3. Access the database UI

- Open http://localhost:8080 in your browser
- Login with:
    - System: PostgreSQL
    - Server: postgres
    - Username: postgres
    - Password: postgres
    - Database: learning_platform

### Database Schema

#### Users

- id (UUID, Primary Key)
- email (VARCHAR, Unique)
- password_hash (VARCHAR) - Encrypted with PostgreSQL pgcrypto (bcrypt)
- name (VARCHAR)
- role (ENUM: 'user' | 'admin')
- created_at (TIMESTAMP)

#### Lessons

- id (UUID, Primary Key)
- title (VARCHAR)
- description (TEXT)
- content (TEXT)
- category (VARCHAR)
- status (ENUM: 'draft' | 'published')
- created_by (UUID, Foreign Key ‚Üí users.id)
- created_at (TIMESTAMP)
- summary (TEXT, Optional)
- image_url (TEXT, Optional)

#### Progress

- id (UUID, Primary Key)
- user_id (UUID, Foreign Key ‚Üí users.id)
- lesson_id (UUID, Foreign Key ‚Üí lessons.id)
- completed (BOOLEAN)
- last_accessed (TIMESTAMP)
- progress (INTEGER, 0-100)

#### Chat Messages

- id (UUID, Primary Key)
- user_id (UUID, Foreign Key ‚Üí users.id)
- lesson_id (UUID, Foreign Key ‚Üí lessons.id)
- role (ENUM: 'user' | 'assistant')
- content (TEXT)
- timestamp (TIMESTAMP)

### Mock Data

The database is seeded with:

- 3 users (1 admin, 2 regular users) with bcrypt-hashed passwords
- 6 lessons covering various programming topics
- Progress data for one user

**Test Accounts:**
| Email | Password | Role |
|-------|----------|------|
| admin@example.com | admin123 | admin |
| user@example.com | user123 | user |
| jane@example.com | user123 | user |

### Password Security

This setup uses PostgreSQL's native `pgcrypto` extension with bcrypt hashing:

- ‚úÖ Passwords are hashed with bcrypt (strong, salted, one-way)
- ‚úÖ No plaintext passwords stored
- ‚úÖ Verification happens in database
- ‚úÖ No additional npm packages needed

**Built-in SQL Functions:**

```sql
-- Register new user (auto-hashes password)
SELECT * FROM register_user('email@example.com', 'password', 'Name', 'user');

-- Verify login (returns user if password matches)
SELECT * FROM verify_login('user@example.com', 'user123');

-- Change password (verifies old password first)
SELECT change_password(user_id, 'oldPass', 'newPass');
```

### Docker Commands

```bash
# Start the database
docker-compose up -d

# Stop the database
docker-compose down

# Stop and remove all data
docker-compose down -v

# View logs
docker-compose logs -f postgres

# Restart database
docker-compose restart postgres
```

### Using the API

1. The PostgREST API is running on **http://localhost:4000**

2. Test login:

```bash
curl -X POST http://localhost:4000/rpc/verify_login \
  -H "Content-Type: application/json" \
  -d "{\"p_email\":\"user@example.com\",\"p_password\":\"user123\"}"
```

3. Get all lessons:

```bash
curl http://localhost:4000/lessons?status=eq.published
```

**Full API documentation:**

- [POSTGREST-GUIDE.md](POSTGREST-GUIDE.md) - Complete API reference
- [RBAC-GUIDE.md](RBAC-GUIDE.md) - JWT Authentication & Role-Based Access Control

## üîê Authentication & Authorization

This API uses **token-based authentication** with **role-based access control (RBAC)**:

‚úÖ **JWT-style tokens** generated by PostgreSQL
‚úÖ **7-day token expiration**
‚úÖ **Admin & User roles**
‚úÖ **Protected endpoints** (admin-only operations)
‚úÖ **Session management**

**Quick Example:**

```bash
# 1. Login and get token
curl -X POST http://localhost:4000/rpc/verify_login \
  -H "Content-Type: application/json" \
  -d '{"p_email":"admin@example.com","p_password":"admin123"}'

# Response includes access_token

# 2. Use token for protected operations
curl -X POST http://localhost:4000/rpc/create_lesson \
  -H "Content-Type: application/json" \
  -d '{"p_token":"YOUR_TOKEN","p_title":"New Lesson",...}'
```

See [RBAC-GUIDE.md](RBAC-GUIDE.md) for complete authentication documentation.

## API Endpoints (Auto-Generated by PostgREST)

### Authentication (RPC Functions)

- POST `/rpc/verify_login` - Login user
- POST `/rpc/register_user` - Register new user
- POST `/rpc/change_password` - Change password

### Users

- GET `/users` - Get all users
- GET `/users?id=eq.{id}` - Get user by ID
- PATCH `/users?id=eq.{id}` - Update user

### Lessons

- GET `/lessons` - Get all lessons
- GET `/lessons?status=eq.published` - Get published lessons
- GET `/lessons?id=eq.{id}` - Get lesson by ID
- POST `/lessons` - Create lesson
- PATCH `/lessons?id=eq.{id}` - Update lesson
- DELETE `/lessons?id=eq.{id}` - Delete lesson

### Progress

- GET `/progress?user_id=eq.{userId}` - Get user's progress
- POST `/progress` - Create/update progress

### Chat Messages

- GET `/chat_messages?user_id=eq.{userId}&lesson_id=eq.{lessonId}` - Get chat history
- POST `/chat_messages` - Send message

**See [POSTGREST-GUIDE.md](POSTGREST-GUIDE.md) for complete API documentation with examples.**

### Lessons

- GET `/api/lessons` - Get all published lessons
- GET `/api/lessons/:id` - Get lesson by ID
- POST `/api/lessons` - Create lesson (admin only)
- PUT `/api/lessons/:id` - Update lesson (admin only)
- DELETE `/api/lessons/:id` - Delete lesson (admin only)

### Progress

- GET `/api/progress/user/:userId` - Get user's progress
- POST `/api/progress` - Update progress
- GET `/api/progress/:userId/:lessonId` - Get specific lesson progress

### Chat

- GET `/api/chat/:userId/:lessonId` - Get chat history
- POST `/api/chat` - Send message

## License

MIT
